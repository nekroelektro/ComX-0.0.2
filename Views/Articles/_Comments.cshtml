@using ComX_0._0._2.Helpers
@using ComX_0._0._2.Views.Articles.Services
@model ComX_0._0._2.Views.Articles.Models.DtoModels.CommentModelDto
@{
    var articleHelper = new ArticleHelper();
    var userHelper = new UserHelper();
    var generalHelper = new GeneralHelper();
    IDocumentService documentService = new DocumentService();
    Guid artId;
    try {
        artId = generalHelper.GetIdFromCurrentUrlForArticle();
    }catch {
        artId = ViewBag.ReturnArticleId;
    }
    var commentList = documentService.GetCommentsForDocument(artId).OrderByDescending(x=>x.DateCreated).ToList();
    Model.IsDiary = ViewBag.IsDocumentDiary;
}

<div id="detailsCommentSection">
    <div class="commentSection">
        <div class="addComment">
            @if (!string.IsNullOrEmpty(User.Identity.Name))
            {
                if (!userHelper.GetCurrentUserProfileInfo().IsBlocked)
                {
                    <h3 class="commentaryHeader">Napisz komentarz trzęsityłku:</h3>
                    using (Ajax.BeginForm("_Comments", new AjaxOptions { UpdateTargetId = "detailsCommentSection" }))
                    {
                        @Html.AntiForgeryToken()
                        <div class="newCommentSection">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <div class="col-xs-12 center-block commentInputBlock">
                                        @Html.Custom_DivFor(model => model.Body, "form-control articleEditorTextArea")
                                        @Html.ValidationMessageFor(model => model.Body, "", new { @class = "text-danger" })
                                    </div>
                                </div>
                                @Html.ValidationMessage("EmptyComment", new { @style = "color: red" })
                                @Html.ValidationMessage("TwoComments", new { @style = "color: red" })
                                <input type="text" class="commentAddFormArtId" name="articleId" value="@artId" />
                                @Html.HiddenFor(model => model.IsDiary)
                                <div class="form-group">
                                    <div class="addcommentButtonContainer">
                                        <button type="submit" class="btn nekrobutton-green addCommentButton">
                                            <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Dodaj komentarz!
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            }
            else {
                <div class="newCommentnotLogged">
                    <h4>Jak chcesz skomentować, to się <a class="popupLoginModal loginComments" href="#login-modal">zaloguj</a> - opłaci Ci się, koleżko!</h4>
                </div>
            }
        </div>
        <hr />
        <h3 class="commentaryHeader">Komentarze(@commentList.Count)</h3>
        <div class="addedCommentsSection col-xs-12" id="commentSection">
            @if (commentList != null)
            {
                foreach (var item in commentList)
                {
                    var currentUser = userHelper.GetUserById(item.UserId);
                    <div class="singleCommentSection col-xs-11 col-xs-offset-1">
                        <div class="col-xs-2 commentFooter">
                            @if (userHelper.GetAvatarByUserId(new Guid(currentUser.Id)) != null)
                            {
                                <img src='@Url.Action("GetAvatar", "Account", new {userId = item.UserId})' />
                            }
                        </div>
                        <div class="col-xs-9 commentBody">
                            <div class="readyCommentDetails">
                                <div class="commentDetailsLeftContainer">
                                    <span class="glyphicon glyphicon-user" aria-hidden="true"></span> @currentUser.UserName &nbsp;&nbsp;&nbsp;&nbsp;
                                    <span class="glyphicon glyphicon-time" aria-hidden="true"></span> @item.DateCreated.ToString()
                                </div>
                                @if (userHelper.UserIsSuperAdmin(userHelper.GetCurrentLoggedUserId()) || item.UserId == userHelper.GetCurrentLoggedUserId())
                                {
                                    <div class="commentDetailsRightContainer">
                                        @*<a href='@Url.Action("CommentEdit", "Articles", new {id = item.Id, articleId = artId})'><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>*@
                                        <a class="popupCommentEdit" data-content='@Url.Action("CommentEdit", "Articles")?id=@item.Id&articleId=@artId' data-id="@item.Id" data-art="@artId" href="#editComment-modal"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
                                        <a class="popupCommentDelete" data-id="@item.Id" data-art="@artId" data-diary="@item.IsDiary" href="#test-modal"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></a>
                                    </div>
                                }
                            </div>
                            <div class="readyCommentBody">
                                @Html.Raw(WebUtility.HtmlDecode(item.Body))
                            </div>
                        </div>

                        <div id="test-modal" class="mfp-hide white-popup">
                            <p>Potwierdź</p>
                            <hr />
                            <p>Czy na bank chcesz usunąć swój komentarz?</p>
                            <button type="button" class="btn btn-danger .btn-sm btnConfirmDeletion" id="commId">
                                Ta!
                            </button>
                            <button type="button" class="btn btn-info .btn-sm btnCancelDeletion">Nope!</button>
                        </div>

                        <div id="editComment-modal" class="mfp-hide white-popup wide-popup">
                            <a class="popupClose"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
                            <div class="editCommentContentInModal"></div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>
    @*SCRIPTS FOR VIEW*@
    <script type="text/javascript" src="~/Views/Articles/Scripts/ArticlesComments.js"></script>
    <link href="~/Views/Articles/Styles/_Comments.css" rel="stylesheet" type="text/css" />
